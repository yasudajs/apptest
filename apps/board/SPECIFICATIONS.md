# 掲示板アプリ仕様書

## 概要

シンプルな掲示板アプリケーション。ユーザーが投稿を作成・閲覧・削除でき、投稿が一定数を超えるとログとしてアーカイブされます。

## アプリケーション構成

```
board/
├── blueprint.py          # Flask Blueprint（ロジック）
├── board.html            # テンプレート（HTML）
├── board.css             # スタイル（CSS）
├── board.js              # スクリプト（JavaScript）
├── log_index.html        # ログ一覧ページテンプレート
├── log_view.html         # ログ詳細ページテンプレート
├── posts.json            # 現在の投稿データ（JSON）
├── log/                  # ログディレクトリ
│   ├── log_manifest.json # ログメタデータ
│   ├── log1.json         # ログ1
│   ├── log2.json         # ログ2
│   └── ...               # その他のログ
└── SPECIFICATIONS.md     # このファイル
```

## 主な機能

### 1. 投稿機能
- **投稿作成**: ユーザーが名前と本文を入力して投稿
- **デフォルト名前**: 名前未入力の場合は「名無しさん」を自動割り当て
- **投稿一覧表示**: 新しい投稿順（逆順）で表示
- **表示件数制限**: デフォルト10件（UI側で選択可能：10/20/30/50/100/全て）

### 2. 削除機能
- **条件付き削除**: 以下の条件をすべて満たす場合のみ削除可能
  - 投稿から7日以内
  - 同じセッションから投稿した本人
- **削除表示**: 削除された投稿は「削除されました」と表示

### 3. ログアーカイブ機能
- **自動アーカイブ**: posts.json内の投稿が200件を超える場合、最古のログをアーカイブ
- **ログ単位**: 100件ごとに1つのログとしてアーカイブ
- **ログ世代**: 最新200件を保持（ログ1とログ2の合計）
- **過去ログ倉庫**: 過去のアーカイブされたログを閲覧可能

## データモデル

### posts.json（現在の投稿）

```json
[
  {
    "post_id": "1_1",
    "name": "投稿者名",
    "content": "投稿内容",
    "created_at": "2025-10-15 21:15:57",
    "is_deleted": false,
    "session_id": "UUID形式のセッションID"
  }
]
```

### log_manifest.json（ログメタデータ）

```json
{
  "current_log": 2,
  "logs": [
    {
      "num": 1,
      "count": 100,
      "created": "2025-10-15 15:30:00"
    },
    {
      "num": 2,
      "count": 100,
      "created": "2025-10-16 10:45:00"
    }
  ]
}
```

### log{n}.json（各ログファイル）

posts.json と同じ形式で100件のアーカイブ投稿を保存

## 投稿ID形式

### 新形式: `log_num_local_num`

例：`1_50`、`2_75`

- `log_num`: ログ番号（1から始まる）
- `local_num`: そのログ内での通番（1～100）

### 従来形式との互換性

古い形式（単なる数値）の投稿ID は自動的に新形式に変換

```
old_id=150 → log_num=2, local_num=50 → "2_50"
```

## セッション管理

### セッションID
- **生成**: 初回アクセス時にUUID形式で自動生成
- **保存**: クッキーに7日間保存（`user_session_id`）
- **用途**: 投稿の削除権確認に使用

### 投稿者名
- **保存**: クッキーに7日間保存（`poster_name`）
- **用途**: 次回投稿時のデフォルト名前
- **条件**: 「名無しさん」以外の場合のみ保存

## ファイル構成と処理フロー

### 投稿追加時の処理フロー

```
1. ユーザーが投稿を送信
2. 次の投稿IDを生成（get_next_post_id）
   - 新規ID: "1_1"
   - または既存の最後のIDをインクリメント
3. 新しい投稿オブジェクトを作成
4. posts.json に追加
5. posts.json内の件数が200件を超えたか確認
   - 超えている場合：最古のログをアーカイブ
     - ログファイル作成
     - マニフェスト更新
     - posts.json から削除
6. ページをリダイレクト
```

### ログアーカイブ時の処理フロー

```
1. posts.json の件数が200件を超える
2. 最古のpost_idから log_num を抽出
3. そのlog_numのすべての投稿を抽出
4. log{log_num}.json として保存
5. log_manifest.json にエントリを追加
6. posts.json からそのlog_numの投稿を削除
7. 以降、posts.json は常に200件以下を維持
```

## APIエンドポイント

### GET `/board/`
掲示板メインページを表示

### POST `/board/add`
新しい投稿を追加
- **パラメータ**: `name`（投稿者名）、`content`（本文）

### POST `/board/delete`
投稿を削除
- **パラメータ**: `post_id`（投稿ID）
- **検証**: セッションID、作成日時、削除可能期間

### GET `/board/api/list`
投稿一覧をJSON形式で返す（JavaScript用）

### GET `/board/logs`
ログ一覧ページを表示

### GET `/board/log/<log_num>`
指定されたログの詳細ページを表示

### GET `/board/<filename>`
静的ファイル（CSS, JS）を提供

## 日時フォーマット

### 表示形式
```
2025/10/15(水) 21:15:57.01
```

### 内部保存形式
```
2025-10-15 21:15:57
```

## 削除権制限

### 削除可能な条件
1. 投稿がまだ削除されていない（`is_deleted = false`）
2. 投稿時のセッションIDと現在のセッションIDが一致
3. 投稿から7日以内（`timedelta(days=7)` より小さい）

### 削除できない理由
- セッション変更（別のブラウザ/デバイス）
- 7日以上前の投稿
- 既に削除された投稿

## 定数設定

| 定数 | 値 | 説明 |
|------|-----|------|
| `MAX_POSTS` | 200 | posts.json に保持する最大投稿数 |
| `BATCH_SIZE` | 100 | ログファイル1つあたりの投稿数 |
| `SESSION_EXPIRE` | 86400*7秒 | セッションクッキーの有効期限（7日） |
| `DELETE_DAYS` | 7日 | 投稿削除可能な期限 |

## セキュリティ考慮事項

### 実装済み
- セッションIDによる削除権制限
- 7日間の削除期限制限
- XSS対策（Jinja2のテンプレート自動エスケープ）

### 推奨される追加対策
- CSRF トークンの実装
- 入力値のバリデーション強化
- レート制限（投稿数制限）
- 不適切コンテンツの自動検出

## パフォーマンス最適化

### 最適化済み
- JSON形式でのシンプルなデータ保存
- ログファイルの分割管理（200件以下に制限）

### 推奨される最適化
- 大規模データ時はデータベース化
- ページネーション実装
- キャッシング機構

## トラブルシューティング

### よくある問題

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| 投稿が保存されない | posts.json へのアクセス権限不足 | ファイル権限を確認 |
| セッションが保持されない | クッキーが有効になっていない | ブラウザ設定確認 |
| 削除ボタンが表示されない | セッション不一致または7日超過 | セッションIDの確認 |
| ログファイルが作成されない | log/ディレクトリの権限不足 | ディレクトリ権限を確認 |

## 今後の拡張機能

- [ ] ユーザー認証機能
- [ ] 検索・フィルター機能
- [ ] リアルタイム更新（WebSocket）
- [ ] 投稿への返信機能
- [ ] 画像アップロード機能
- [ ] マークダウン対応
- [ ] 投稿の編集機能
- [ ] カテゴリ分類機能
