# 掲示板アプリ仕様書

## 概要

シンプルな掲示板アプリケーション。ユーザーが投稿を作成・閲覧・削除でき、投稿が一定数を超えるとログとしてアーカイブされます。

## アプリケーション構成

```
board/
├── blueprint.py          # Flask Blueprint（ロジック）
├── board.db              # SQLiteデータベースファイル
├── board.html            # テンプレート（HTML）
├── board.css             # スタイル（CSS）
├── board.js              # スクリプト（JavaScript）
├── log_index.html        # ログ一覧ページテンプレート
├── log_view.html         # ログ詳細ページテンプレート
├── documents/            # 仕様書・定義書
│   ├── SPECIFICATIONS.md # このファイル
│   ├── table_definition.md # DBテーブル定義
│   └── db_migration_plan.md # DB移行計画
└── SPECIFICATIONS.md     # このファイル
```

## 主な機能

### 1. 投稿機能
- **投稿作成**: ユーザーが名前と本文を入力して投稿
- **デフォルト名前**: 名前未入力の場合は「名無しさん」を自動割り当て
- **投稿一覧表示**: 古い投稿を上、新しい投稿を下に表示（時系列順）
- **表示件数制限**: デフォルト10件（UI側で選択可能：10/20/30/50/100/全て）

### 2. 削除機能
- **条件付き削除**: 以下の条件をすべて満たす場合のみ削除可能
  - 投稿から7日以内
  - 同じセッションから投稿した本人
- **削除表示**: 削除された投稿は「削除されました」と表示

### 3. ログアーカイブ機能
- **自動アーカイブ**: postsテーブルの投稿が200件を超える場合、最古のログをアーカイブ
- **ログ単位**: 100件ごとに1つのログとしてアーカイブ
- **ログ世代**: 最新200件を保持（ログ1とログ2の合計）
- **過去ログ倉庫**: 過去のアーカイブされたログを閲覧可能
- **ログ一覧表示**: 100件ちょうどのログのみ表示、100件目の投稿日時を表示（例: ログ 1 (投稿 1_1 ～ 1_100) - 100件 [2025/11/11(火) 13:42:00.01]）

## データモデル

### postsテーブル（SQLiteデータベース）

postsテーブルの構造については `table_definition.md` を参照してください。

## 投稿ID形式

### 形式: `log_id_local_id`

例：`1_50`、`2_75`

- `log_id`: ログ番号（1から始まる）
- `local_id`: そのログ内での通番（1～100）

## セッション管理

### セッションID
- **生成**: 初回アクセス時にUUID形式で自動生成
- **保存**: クッキーに7日間保存（`user_session_id`）
- **用途**: 投稿の削除権確認に使用

### 投稿者名
- **保存**: クッキーに7日間保存（`poster_name`）
- **用途**: 次回投稿時のデフォルト名前
- **条件**: 「名無しさん」以外の場合のみ保存

## ファイル構成と処理フロー

### 投稿追加時の処理フロー

```
1. ユーザーが投稿を送信
2. 次の投稿IDを生成（get_next_log_local_ids）
   - 新規ID: log_id=1, local_id=1
   - または既存の最後のIDをインクリメント
3. 新しい投稿レコードを作成
4. postsテーブルにINSERT
5. postsテーブルの件数が200件を超えたか確認
   - 超えている場合：最古のログをアーカイブ（DB内で管理）
6. ページをリダイレクト
```

### ログアーカイブ時の処理フロー

```
1. postsテーブルの件数が200件を超える
2. 最古のlog_idのすべての投稿を抽出
3. ログファイル作成（JSON形式でエクスポート）
4. log_manifest.json にエントリを追加
5. postsテーブルからそのlog_idの投稿をDELETE
6. 以降、postsテーブルは常に200件以下を維持
```

## APIエンドポイント

### GET `/board/`
掲示板メインページを表示

### POST `/board/add`
新しい投稿を追加
- **パラメータ**: `name`（投稿者名）、`content`（本文）

### POST `/board/delete`
投稿を削除
- **パラメータ**: `post_id`（投稿ID）
- **検証**: セッションID、作成日時、削除可能期間

### GET `/board/api/list`
投稿一覧をJSON形式で返す（JavaScript用）

### GET `/board/logs`
ログ一覧ページを表示

### GET `/board/log/<log_num>`
指定されたログの詳細ページを表示

### GET `/board/<filename>`
静的ファイル（CSS, JS）を提供

## 日時フォーマット

### 表示形式
```
2025/10/15(水) 21:15:57.01
```

### 内部保存形式
```
2025-10-15 21:15:57
```

## 削除権制限

### 削除可能な条件
1. 投稿がまだ削除されていない（`is_deleted = false`）
2. 投稿時のセッションIDと現在のセッションIDが一致
3. 投稿から7日以内（`timedelta(days=7)` より小さい）

### 削除できない理由
- セッション変更（別のブラウザ/デバイス）
- 7日以上前の投稿
- 既に削除された投稿

## 定数設定

| 定数 | 値 | 説明 |
|------|-----|------|
| `MAX_POSTS` | 200 | postsテーブルに保持する最大投稿数 |
| `BATCH_SIZE` | 100 | ログファイル1つあたりの投稿数 |
| `SESSION_EXPIRE` | 86400*7秒 | セッションクッキーの有効期限（7日） |
| `DELETE_DAYS` | 7日 | 投稿削除可能な期限 |

## セキュリティ考慮事項

### 実装済み
- セッションIDによる削除権制限
- 7日間の削除期限制限
- XSS対策（Jinja2のテンプレート自動エスケープ）

### 推奨される追加対策
- CSRF トークンの実装
- 入力値のバリデーション強化
- レート制限（投稿数制限）
- 不適切コンテンツの自動検出

## パフォーマンス最適化

### 最適化済み
- SQLiteデータベースでの効率的なデータ管理
- Primary Key (id) を活用した高速ソート
- ログファイルの分割管理（200件以下に制限）

### 推奨される最適化
- 大規模データ時はより高性能なDB移行を検討
- ページネーション実装
- キャッシング機構

## トラブルシューティング

### よくある問題

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| 投稿が保存されない | board.db へのアクセス権限不足 | ファイル権限を確認 |
| セッションが保持されない | クッキーが有効になっていない | ブラウザ設定確認 |
| 削除ボタンが表示されない | セッション不一致または7日超過 | セッションIDの確認 |
| ログファイルが作成されない | board.db の権限不足またはログディレクトリの権限不足 | DBファイルとディレクトリ権限を確認 |

## 同時アクセス時のトランザクション処理

### トランザクション実装
- **自動トランザクション**: `with get_db() as db:` でコンテキストマネージャを使用
- **自動コミット**: withブロック終了時に自動コミット
- **自動ロールバック**: 例外発生時に自動ロールバック

### SQLiteの同時アクセス制御
- **排他ロック**: 書き込み操作時はデータベース全体に排他ロック
- **シリアライズ実行**: 同時書き込みは順次処理され、データ競合を防ぐ
- **読み取り並行**: 読み取り操作は並行して実行可能

### 投稿追加時の処理フロー（同時アクセス時）
1. **ユーザーAが投稿**: DBロック取得 → log_id/local_id計算 → INSERT → コミット → ロック解放
2. **ユーザーBが同時投稿**: ロック待機 → Aの処理完了後ロック取得 → log_id/local_id再計算 → INSERT → コミット

### 注意点
- **パフォーマンス**: SQLiteは1つの書き込み操作しか同時に処理できない
- **データ整合性**: ユニーク制約 (log_id, local_id) で重複防止
- **高負荷時**: 多数の同時アクセス時はPostgreSQLなどのDB移行を検討
